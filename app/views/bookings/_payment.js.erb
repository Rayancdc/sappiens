var button = document.querySelector('button');
const transaction_data = {
  user_id: <%= current_user.id %>,
  name: '<%= current_user.name %>',
  email: '<%= current_user.email %>',
  price: <%= @event.experience.price_cents %>,
  event_id: <%= params[:event_id] %>,
  experience_id: <%= params[:experience_id] %>,
}
console.log(transaction_data);
// Abrir o modal ao clicar no botão
button.addEventListener('click', function() {

  // inicia a instância do checkout
  var checkout = new PagarMeCheckout.Checkout({
    encryption_key: 'ek_test_TMzQwiRw9lqPsbScwhmN2yt1FHQ0Q2',
    success: function(payment_data) {
      $.ajax({
        url: `/experiences/${transaction_data.experience_id}/events/${transaction_data.event_id}/bookings`,
        data: { token : payment_data.token },
        dataType: "json",
        type: "POST",
        success: function(data) {
          window.location.href = `/bookings/${data.booking_id}`
        },
        error: function(data) {
          console.log(data.errors);
        }
      });
    },
    error: function(err) {
      console.log(err);
      console.log("Attempting again");
      $.ajax({
        url: `/experiences/${transaction_data.experience_id}/events/${transaction_data.event_id}/bookings`,
        data: { token : payment_data.token },
        dataType: "json",
        type: "POST",
        success: function(data) {
          window.location.href = `/bookings/${data.booking_id}`
        },
        error: function(data) {
          console.log(data.errors)
        }
      });
    }
});

// Obs.: é necessário passar os valores boolean como string
  checkout.open({
    amount: transaction_data.price,
    createToken: 'true',
    paymentMethods: 'credit_card',
    customerData: false,
    customer: {
      external_id: transaction_data.user_id,
      name: transaction_data.name,
      type: 'individual',
      country: 'br',
      email: transaction_data.email,
      documents: [
        {
          type: 'cpf',
          number: '71404665560',
        },
      ],
      phone_numbers: ['+5511999998888'],
      birthday: '1985-01-01',
    },
    billing: {
      name: transaction_data.name,
      address: {
        country: 'br',
        state: ' ',
        city: ' ',
        neighborhood: ' ',
        street: ' ',
        street_number: ' ',
        zipcode: '00000000'
      }
    },
    items: [
      {
        id: '1',
        title: 'Booking',
        unit_price: transaction_data.price,
        quantity: 1,
        tangible: false
      }
    ]
  })
});
